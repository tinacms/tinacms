name: Publish SNZ

on:
  push:
    branches-ignore:
      - 'main' # upstream mirror
  workflow_dispatch:
    inputs:
      force_snz:
        description: "Force SNZ publish even if not on streamliners-main"
        required: false
        default: "false"
      dry_run:
        description: "Do a dry run (no actual publish)"
        required: false
        default: "true"

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      GITHUB_TOKEN: ${{ secrets.NPM_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: package.json
          run_install: false

      - name: Setup git credentials
        run: |
          git config --global user.email "ci@streamliners.co.nz"
          git config --global user.name "Streamliners CI"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-2

      - name: Get CodeArtifact token
        id: codeartifact-token
        run: |
          TOKEN=$(aws codeartifact get-authorization-token \
            --domain streamliners-npm \
            --domain-owner 368438108069 \
            --query authorizationToken --output text)
          echo "CODEARTIFACT_TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: Configure .npmrc for AWS CodeArtifact
        run: |
          echo "registry=https://streamliners-npm-368438108069.d.codeartifact.ap-southeast-2.amazonaws.com/npm/tina-cms-snz/" > ~/.npmrc
          echo "//streamliners-npm-368438108069.d.codeartifact.ap-southeast-2.amazonaws.com/npm/tina-cms-snz/:_authToken=${CODEARTIFACT_TOKEN}" >> ~/.npmrc

      # ----------------------------------------------------------------- #
      # Get all packages and treat them as "changed" for this workflow
      # ----------------------------------------------------------------- #
      - name: Get all package paths
        id: changed
        shell: bash
        run: |
          set -euo pipefail

          echo "Listing all workspace packages..."
          # List all workspaces quickly (no install required)
          pnpm -r list --depth=-1 --json > workspace_list.json

          # Map all workspaces to paths and write to changed_paths.txt
          node -e '
            const fs = require("fs");
            const path = require("path");
            const repo = process.cwd();
            const toAbs = p => path.resolve(repo, p);

            let workspaces = [];
            try { workspaces = JSON.parse(fs.readFileSync("workspace_list.json","utf8")) || []; } catch {}
            if (!Array.isArray(workspaces)) workspaces = [];
            workspaces = workspaces
              .filter(Boolean)
              .map(w => ({ name: w.name, version: w.version, path: toAbs(w.path || w.dir || ""), private: !!w.private }))
              .filter(w => w.path && fs.existsSync(w.path));

            const rels = workspaces.map(w => path.relative(repo, w.path));
            fs.writeFileSync("changed_paths.txt", rels.join("\n") + (rels.length ? "\n" : ""));

            fs.writeFileSync("changed_list.json", JSON.stringify(workspaces));
          '

          echo "All package paths:"
          cat changed_paths.txt || true

          CHANGED_COUNT=$(grep -c . changed_paths.txt || true)
          echo "CHANGED_COUNT=${CHANGED_COUNT}" | tee -a "$GITHUB_ENV"

          # Compact JSON into one line to safely export as env
          node -e 'const fs=require("fs"); const j=fs.readFileSync("changed_list.json","utf8"); const o=j ? JSON.parse(j) : []; process.stdout.write(JSON.stringify(o));' > changed_list.compact.json
          echo "CHANGED_JSON=$(cat changed_list.compact.json)" >> "$GITHUB_ENV"

      # registry rewrite (safe to run after captured diffs)
      - name: Update all package.json files
        run: node scripts/update-package-jsons.js

      - name: Clean workspace and prepare
        run: |
          find . -name "node_modules" -type d -exec rm -rf {} +
          find . -name ".turbo" -type d -exec rm -rf {} +

          # Also create a local .npmrc for publishes from repo root
          echo "registry=https://streamliners-npm-368438108069.d.codeartifact.ap-southeast-2.amazonaws.com/npm/tina-cms-snz/" > .npmrc
          echo "//streamliners-npm-368438108069.d.codeartifact.ap-southeast-2.amazonaws.com/npm/tina-cms-snz/:_authToken=${CODEARTIFACT_TOKEN}" >> .npmrc

          pnpm install --no-frozen-lockfile

          # Build scripts first
          cd packages/@tinacms/scripts
          pnpm build
          cd ../..

          pnpm build
          pnpm types

      # Build pnpm --filter args from changed_paths.txt
      - name: Build pnpm filters
        id: filters
        shell: bash
        run: |
          set -euo pipefail
          FILTERS=""
          if [[ -f changed_paths.txt ]]; then
            while IFS= read -r p; do
              [[ -z "$p" ]] && continue
              FILTERS="$FILTERS --filter ./$p"
            done < changed_paths.txt
          fi
          echo "FILTERS=${FILTERS}" >> $GITHUB_ENV
          echo "Filters: $FILTERS"

      # ------------------------------------- #
      # PREVIEW: feature branches -> tag beta
      # ------------------------------------- #
      - name: Bump snapshot versions (ALL PACKAGES)
        if: ${{ github.ref != 'refs/heads/streamliners-main' && (github.event_name != 'workflow_dispatch' || inputs.force_snz != 'true') }}
        run: |
          set -euo pipefail
          if [[ "${CHANGED_COUNT:-0}" -eq 0 ]]; then
            echo "No changed packages to snapshot."
            exit 0
          fi

          SNAPSHOT_SUFFIX="$(git rev-parse --short "$GITHUB_SHA")-$(date -u +%Y%m%d%H%M%S)"
          echo "Using snapshot suffix: $SNAPSHOT_SUFFIX"
          export SNAPSHOT_SUFFIX

          node -e '
            const fs = require("fs");
            const paths = fs.readFileSync("changed_paths.txt","utf8").trim().split("\n").filter(Boolean);
            const suffix = process.env.SNAPSHOT_SUFFIX;
            let bumped = [];
            for (const p of paths) {
              const pj = p.replace(/\/$/, "") + "/package.json";
              if (!fs.existsSync(pj)) continue;
              const data = JSON.parse(fs.readFileSync(pj,"utf8"));
              if (data.private) continue;
              const newVer = `0.0.0-${suffix}`;
              data.version = newVer;
              fs.writeFileSync(pj, JSON.stringify(data, null, 2) + "\n");
              bumped.push(`${data.name}@${newVer}`);
            }
            console.log("BUMPED_SNAPSHOTS=" + JSON.stringify(bumped));
          ' | tee snapshot_bump.log

     
      - name: Show snapshot versions in summary
        if: ${{ github.ref != 'refs/heads/streamliners-main' && (github.event_name != 'workflow_dispatch' || inputs.force_snz != 'true') }}
        run: |
          echo "## üì¶ Snapshot Versions (tag: beta)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ -f snapshot_bump.log ]]; then
            grep "BUMPED_SNAPSHOTS=" snapshot_bump.log | sed 's/BUMPED_SNAPSHOTS=//' | \
              node -e '
                const input = require("fs").readFileSync(0, "utf8").trim();
                const packages = JSON.parse(input);
                packages.forEach(pkg => console.log(`- ${pkg}`));
              ' >> $GITHUB_STEP_SUMMARY
          else
            echo "No packages to snapshot." >> $GITHUB_STEP_SUMMARY
          fi
   

      - name: Publish preview (all packages) to CodeArtifact with tag=beta
        if: ${{ github.ref != 'refs/heads/streamliners-main' && (github.event_name != 'workflow_dispatch' || inputs.force_snz != 'true') }}
        run: |
          set -euo pipefail
          if [[ "${CHANGED_COUNT:-0}" -eq 0 ]]; then
            echo "Nothing to publish (no workspace changes)."
            exit 0
          fi

          DRY_FLAG=""
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.dry_run }}" == "true" ]]; then
            DRY_FLAG="--dry-run"
          fi

          pnpm publish -r \
            $FILTERS \
            --tag beta \
            --no-git-checks \
            --access public \
            ${DRY_FLAG}

      # ------------------------------------- #
      # STABLE-INTERNAL (SNZ): streamliners-main or forced
      # ------------------------------------- #
      - name: Bump SNZ prerelease versions (ALL PACKAGES)
        if: ${{ github.ref == 'refs/heads/streamliners-main' || (github.event_name == 'workflow_dispatch' && inputs.force_snz == 'true') }}
        run: |
          set -euo pipefail
          if [[ "${CHANGED_COUNT:-0}" -eq 0 ]]; then
            echo "No changed packages to SNZ-bump."
            exit 0
          fi

          SNAPSHOT_SUFFIX="$(git rev-parse --short "$GITHUB_SHA")-$(date -u +%Y%m%d%H%M%S)"
          echo "Using SNZ suffix: $SNAPSHOT_SUFFIX"
          export SNAPSHOT_SUFFIX

          node -e '
            const fs = require("fs");
            const suffix = process.env.SNAPSHOT_SUFFIX;
            const paths = fs.readFileSync("changed_paths.txt","utf8").trim().split("\n").filter(Boolean);
            let bumped = [];
            for (const p of paths) {
              const pj = p.replace(/\/$/, "") + "/package.json";
              if (!fs.existsSync(pj)) continue;
              const data = JSON.parse(fs.readFileSync(pj,"utf8"));
              if (data.private) continue;
              const base = String(data.version || "").replace(/-snz\..*$/,"");
              if (!base) continue;
              const newVer = `${base}-snz.${suffix}`;
              data.version = newVer;
              fs.writeFileSync(pj, JSON.stringify(data, null, 2) + "\n");
              bumped.push(`${data.name}@${newVer}`);
            }
            console.log("BUMPED_SNZ=" + JSON.stringify(bumped));
          ' | tee snz_bump.log
           
          echo "## üì¶ SNZ Versions (tag: snz + latest)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ -f snz_bump.log ]]; then
            grep "BUMPED_SNZ=" snz_bump.log | sed 's/BUMPED_SNZ=//' | \
              node -e '
                const input = require("fs").readFileSync(0, "utf8").trim();
                const packages = JSON.parse(input);
                packages.forEach(pkg => console.log(`- ${pkg}`));
              ' >> $GITHUB_STEP_SUMMARY
          fi
                
      - name: Publish SNZ prerelease (all packages) to CodeArtifact with tag=snz
        if: ${{ github.ref == 'refs/heads/streamliners-main' || (github.event_name == 'workflow_dispatch' && inputs.force_snz == 'true') }}
        run: |
          set -euo pipefail
          if [[ "${CHANGED_COUNT:-0}" -eq 0 ]]; then
            echo "Nothing to publish (no workspace changes)."
            exit 0
          fi

          DRY_FLAG=""
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.dry_run }}" == "true" ]]; then
            DRY_FLAG="--dry-run"
          fi

          pnpm publish -r \
            $FILTERS \
            --tag snz \
            --no-git-checks \
            --access public \
            ${DRY_FLAG}
          
          # üè∑Ô∏è  Assign 'latest' tag to published SNZ packages
          if [[ -z "$DRY_FLAG" ]]; then
          echo ""
            echo "‚è≥ Waiting 10 seconds for packages to be available in registry..."
            sleep 10
            
            echo "üè∑Ô∏è  Assigning 'latest' tag to SNZ packages:"
            echo "=============================================="
      
            # Read the bumped packages from the previous step's log
            if [[ -f snz_bump.log ]]; then
              # Extract package names and versions from the bump log
              while IFS= read -r line; do
                if [[ $line =~ BUMPED_SNZ= ]]; then
                  # Parse the JSON array of package@version strings
                  echo "$line" | node -e '
                    const fs = require("fs");
                    const input = fs.readFileSync(0, "utf8");
                    const match = input.match(/BUMPED_SNZ=(\[.*\])/);
                    if (match) {
                      const packages = JSON.parse(match[1]);
                      packages.forEach(pkg => {
                        const lastAtIndex = pkg.lastIndexOf("@");
                        if (lastAtIndex > 0) {
                         const name = pkg.substring(0, lastAtIndex);
                         const version = pkg.substring(lastAtIndex + 1);
                         if (name && version) {
                           console.log(`${name}@${version}`);
                         } 
                        }                       
                      });
                    }
                  ' | while read pkgver; do
                    echo "  üì¶ Tagging $pkgver as 'latest'"
                    npm dist-tag add "$pkgver" latest \
                      --registry=https://streamliners-npm-368438108069.d.codeartifact.ap-southeast-2.amazonaws.com/npm/tina-cms-snz/ \
                      || echo "‚ö†Ô∏è  Failed to tag $pkgver"
                  done
                fi
              done < snz_bump.log
            fi
      
            echo "=============================================="
            echo "‚úÖ Latest tags applied to all SNZ packages."
          else
            echo "‚è≠Ô∏è  Skipping 'latest' tag assignment (dry run mode)"
          fi

      - name: Summary
        if: always()
        run: |
          echo "üìù Build completed. Branch: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Changed packages since base:" >> $GITHUB_STEP_SUMMARY
          echo '${{ env.CHANGED_JSON }}' >> $GITHUB_STEP_SUMMARY